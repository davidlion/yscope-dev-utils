version: "3"

set: ["u", "pipefail"]
shopt: ["globstar"]

tasks:
  # Runs `clang-format` on files found after searching and filtering. Each path in `ROOT_PATHS` is
  # recursively searched for files. Paths matching any `EXCLUDE_PATTERNS` are skipped. File paths
  # matching at least one entry from `INCLUDE_PATTERNS` and at least one entry from
  # `EXCLUDE_PATTERNS` are passed to `clang-format`.
  #
  # General parameters
  # @param {string} VENV_DIR Python virtual environment where `clang-format` is installed.
  # @param {string[]} ROOT_PATHS Paths recursively searched for files to run on.
  # @param {string[]} [FLAGS] Any flags to pass to `clang-format`.
  #
  # Pattern parameters
  # @param {string[]} [EXCLUDE_PATTERNS] Wildcard patterns where any matching paths (relative to
  # `ROOT_PATHS`) will be excluded. The search will not descend into matching directory paths. By
  # default no paths match.
  # @param {string[]} [EXTENSION_PATTERNS=["*.cpp", "*.h", "*.hpp"]] Wildcard patterns matched
  # against the file name (not the full path) determining files to run on.
  # @param {string[]} [INCLUDE_PATTERNS] Wildcard patterns where any matching file paths (relative
  # to `ROOT_PATHS`) will be included. By default all paths match.
  clang-format:
    internal: true
    vars:
      # General parameters
      FLAGS:
        ref: "default (list) .FLAGS"

      # Filtering parameters
      EXCLUDE_PATTERNS:
        ref: "default (list) .EXCLUDE_PATTERNS"
      EXTENSION_PATTERNS:
        ref: >-
          default (list "*.cpp" "*.h" "*.hpp") .EXTENSION_PATTERNS
      INCLUDE_PATTERNS:
        ref: "default (list) .INCLUDE_PATTERNS"
    requires:
      vars: ["ROOT_PATHS", "VENV_DIR"]
    cmd: |-
      . "{{.VENV_DIR}}/bin/activate"
      find \
        {{- range .ROOT_PATHS}}
          {{.}} \
        {{- end}}
        {{- if .EXCLUDE_PATTERNS}}
          \( \
            {{- range $i, $pattern := .EXCLUDE_PATTERNS}}
              {{- if $i}}
                -or \
              {{- end}}
              -path "{{$pattern}}" \
            {{- end}}
          \) \
          -prune \
          -or \
        {{- end}}
        -type f \
        {{- if .INCLUDE_PATTERNS}}
          \( \
            {{- range $i, $pattern := .INCLUDE_PATTERNS}}
              {{- if $i}}
                -or \
              {{- end}}
              -path "{{$pattern}}" \
            {{- end}}
          \) \
        {{- end}}
        {{- if .EXTENSION_PATTERNS}}
          \( \
            {{- range $i, $pattern := .EXTENSION_PATTERNS}}
              {{- if $i}}
                -or \
              {{- end}}
              -name "{{$pattern}}" \
            {{- end}}
          \) \
        {{- end}}
        -print0
      | xargs -0 clang-format \
        {{- range .FLAGS}}
          {{.}} \
        {{- end}}
        -Werror

  # Runs `clang-tidy` on `SOURCE_PATH` and writes the output to `OUTPUT_PATH`. The strings "Passed"
  # or "Failed" are appended to the output file, depending on the result.
  #
  # @param {string} OUTPUT_PATH Path to output log of `clang-tidy` for `SOURCE_PATH`.
  # @param {string} SOURCE_PATH Source file path to run `clang-tidy` on.
  # @param {string} VENV_DIR Python virtual environment where `clang-tidy` is installed.
  # @param {string[]} [FLAGS] Any flags to pass to `clang-tidy`.
  clang-tidy:
    internal: true
    label: "{{.TASK}}:{{.SOURCE_PATH}}"
    sources: ["{{.SOURCE_PATH}}"]
    vars:
      FLAGS:
        ref: "default (list) .FLAGS"
    requires:
      vars: ["OUTPUT_PATH", "SOURCE_PATH", "VENV_DIR"]
    generates: ["{{.OUTPUT_PATH}}"]
    cmds:
      - defer: |-
          if [[ 0 -eq "{{.EXIT_CODE}}" ]]; then
            echo "Passed" >> "{{.OUTPUT_PATH}}"
          else
            echo "Failed" >> "{{.OUTPUT_PATH}}"
          fi
      - |-
        . "{{.VENV_DIR}}/bin/activate"
        clang-tidy \
          {{- range .FLAGS}}
            {{.}} \
          {{- end}}
          "{{.SOURCE_PATH}}" &> "{{.OUTPUT_PATH}}"

  # Runs `clang-tidy` in parallel on C++ source files that differ between HEAD and the target
  # branch. On failure, `clang-tidy`'s output is printed. The task will fail on the first file which
  # fails `clang-tidy`'s checks, which will result in some files having incomplete output. Users can
  # either fix the known errors and run the task again or directly run `clang-tidy` on a file of
  # interest.
  #
  # @param {string} VENV_DIR Python virtual environment where `clang-tidy` is installed.
  # @param {string} [GIT_REF="origin/main"] A `git` reference that HEAD is diff'd with.
  # @param {string[]} [FLAGS] Any flags to pass to `clang-tidy`.
  # @param {string} [OUTPUT_DIR="{{.ROOT_DIR}}/lint-clang-tidy"] Directory to store the `clang-tidy`
  # output for each file.
  clang-tidy-diff:
    internal: true
    label: "{{.TASK}}:{{.OUTPUT_DIR}}"
    vars:
      GIT_REF: >-
        {{default "origin/main" .GIT_REF}}
      DIFF_SOURCE_PATHS_:
        sh: >-
          git diff --name-only --ignore-submodules "{{.GIT_REF}}" **/*.{cpp,h,hpp}
          | xargs --no-run-if-empty realpath
      DIFF_SOURCE_PATHS:
        ref: >-
          splitList "\n" .DIFF_SOURCE_PATHS_
      FLAGS:
        ref: "default (list) .FLAGS"
      OUTPUT_DIR: >-
        {{default "{{.ROOT_DIR}}/lint-clang-tidy" .OUTPUT_DIR}}
    requires:
      vars: ["VENV_DIR"]
    dir: "{{.ROOT_DIR}}"
    cmds:
      - task: ":clang-tidy-output"
        vars:
          FLAGS:
            ref: ".FLAGS"
          OUTPUT_DIR: "{{.OUTPUT_DIR}}"
          SOURCE_PATHS:
            ref: ".DIFF_SOURCE_PATHS"
          VENV_DIR: "{{.VENV_DIR}}"

  # Runs `clang-tidy` on files found after searching and filtering. Each path in `ROOT_PATHS` is
  # recursively searched for files. Paths matching any `EXCLUDE_PATTERNS` are skipped. File paths
  # matching at least one entry from `INCLUDE_PATTERNS` and at least one entry from
  # `EXCLUDE_PATTERNS` are passed to `clang-tidy`.
  #
  # General parameters
  # @param {string} VENV_DIR Python virtual environment where `clang-tidy` is installed.
  # @param {string[]} ROOT_PATHS Paths recursively searched for files to run on.
  # @param {string[]} [FLAGS] Any flags to pass to `clang-tidy`.
  # @param {string} [OUTPUT_DIR="{{.ROOT_DIR}}/lint-clang-tidy"] Directory to store the `clang-tidy`
  # output for each file.
  #
  # Pattern parameters
  # @param {string[]} [EXCLUDE_PATTERNS] Wildcard patterns where any matching paths (relative to
  # `ROOT_PATHS`) will be excluded. The search will not descend into matching directory paths. By
  # default no paths match.
  # @param {string[]} [EXTENSION_PATTERNS=["*.cpp", "*.h", "*.hpp"]] Wildcard patterns matched
  # against the file name (not the full path) determining files to run on.
  # @param {string[]} [INCLUDE_PATTERNS] Wildcard patterns where any matching file paths (relative
  # to `ROOT_PATHS`) will be included. By default all paths match.
  clang-tidy-find:
    internal: true
    label: "{{.TASK}}:{{.OUTPUT_DIR}}"
    vars:
      # General parameters
      FLAGS:
        ref: "default (list) .FLAGS"
      OUTPUT_DIR: >-
        {{default "{{.ROOT_DIR}}/lint-clang-tidy" .OUTPUT_DIR}}

      # Pattern parameters
      EXCLUDE_PATTERNS:
        ref: "default (list) .EXCLUDE_PATTERNS"
      EXTENSION_PATTERNS:
        ref: >-
          default (list "*.cpp" "*.h" "*.hpp") .EXTENSION_PATTERNS
      INCLUDE_PATTERNS:
        ref: "default (list) .INCLUDE_PATTERNS"

      # Task variables
      SOURCE_PATHS_:
        # Do not quote `ROOT_PATHS` entries so that wildcards can be evaluated by the shell.
        sh: |-
          find \
            {{- range .ROOT_PATHS}}
              {{.}} \
            {{- end}}
            {{- if .EXCLUDE_PATTERNS}}
              \( \
                {{- range $i, $pattern := .EXCLUDE_PATTERNS}}
                  {{- if $i}}
                    -or \
                  {{- end}}
                  -path "{{$pattern}}" \
                {{- end}}
              \) \
              -prune \
              -or \
            {{- end}}
            -type f \
            {{- if .INCLUDE_PATTERNS}}
              \( \
                {{- range $i, $pattern := .INCLUDE_PATTERNS}}
                  {{- if $i}}
                    -or \
                  {{- end}}
                  -path "{{$pattern}}" \
                {{- end}}
              \) \
            {{- end}}
            {{- if .EXTENSION_PATTERNS}}
              \( \
                {{- range $i, $pattern := .EXTENSION_PATTERNS}}
                  {{- if $i}}
                    -or \
                  {{- end}}
                  -name "{{$pattern}}" \
                {{- end}}
              \) \
            {{- end}}
            -print0
      SOURCE_PATHS:
        # `-print0` output ends in "\x00" causing `splitList` to generate an empty entry, that we
        # remove using `compact`.
        ref: >-
          compact (splitList "\x00" .SOURCE_PATHS_)
    requires:
      vars: ["ROOT_PATHS", "VENV_DIR"]
    cmds:
      - task: "clang-tidy-output"
        vars:
          FLAGS:
            ref: ".FLAGS"
          OUTPUT_DIR: "{{.OUTPUT_DIR}}"
          SOURCE_PATHS:
            ref: ".SOURCE_PATHS"
          VENV_DIR: "{{.VENV_DIR}}"

  # Runs `clang-tidy-parallel` and prints completed output logs on failure. Output logs that are
  # incomplete or don't exist (`clang-tidy` didn't get a chance to run for the file) are skipped.
  #
  # @param {string[]} SOURCE_PATHS List of source file paths.
  # @param {string} VENV_DIR Python virtual environment where `clang-tidy` is installed.
  # @param {string[]} [FLAGS] Any flags to pass to `clang-tidy`.
  # @param {string} [OUTPUT_DIR="{{.ROOT_DIR}}/lint-clang-tidy"] Directory to store the `clang-tidy`
  # output for each file.
  clang-tidy-output:
    internal: true
    vars:
      FLAGS:
        ref: "default (list) .FLAGS"
      OUTPUT_DIR: >-
        {{default "{{.ROOT_DIR}}/lint-clang-tidy" .OUTPUT_DIR}}
    requires:
      vars: ["SOURCE_PATHS", "VENV_DIR"]
    cmds:
      - defer: |-
          {{- if .EXIT_CODE}}
            {{- $output_dir := .OUTPUT_DIR}}
            {{- range .SOURCE_PATHS}}
              {{- $output_path := printf "%s/%s.log" $output_dir (replace "/" "-" .)}}
              if [[ -f "{{$output_path}}" ]] \
                  && [[ "Failed" == "$(tail -n 1 {{$output_path}})" ]]; then
                tail -v -n +1 "{{$output_path}}"
              fi
            {{- end}}
          {{- end}}
      - "mkdir -p '{{.OUTPUT_DIR}}'"
      - task: "clang-tidy-parallel"
        vars:
          FLAGS:
            ref: ".FLAGS"
          OUTPUT_DIR: "{{.OUTPUT_DIR}}"
          SOURCE_PATHS:
            ref: ".SOURCE_PATHS"
          VENV_DIR: "{{.VENV_DIR}}"

  # Runs `clang-tidy` in parallel on `SOURCE_PATHS`, storing the output for each file in
  # `OUTPUT_DIR`. Each output file is named after the source file path except '/' is replaced with
  # '-' and the file is suffixed with '.log'. The task will fail on the first file to fail
  # `clang-tidy`, which may result in some files having incomplete output.
  #
  # @param {string[]} SOURCE_PATHS List of source file paths.
  # @param {string} VENV_DIR Python virtual environment where `clang-tidy` is installed.
  # @param {string[]} [FLAGS] Any flags to pass to `clang-tidy`.
  # @param {string} [OUTPUT_DIR="{{.ROOT_DIR}}/lint-clang-tidy"] Directory to store the `clang-tidy`
  # output for each file.
  clang-tidy-parallel:
    internal: true
    vars:
      FLAGS:
        ref: "default (list) .FLAGS"
      OUTPUT_DIR: >-
        {{default "{{.ROOT_DIR}}/lint-clang-tidy" .OUTPUT_DIR}}
    requires:
      vars: ["SOURCE_PATHS", "VENV_DIR"]
    deps:
      - for: { var: SOURCE_PATHS }
        task: "clang-tidy"
        vars:
          FLAGS:
            ref: ".FLAGS"
          OUTPUT_PATH: >-
            {{printf "%s/%s.log" .OUTPUT_DIR (replace "/" "-" .ITEM)}}
          SOURCE_PATH: "{{.ITEM}}"
          VENV_DIR: "{{.VENV_DIR}}"
